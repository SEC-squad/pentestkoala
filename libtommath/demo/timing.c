#include <tommath.h>
#include <time.h>

ulong64 _tt;

#ifdef IOWNANATHLON
#include <unistd.h>
#define SLEEP sleep(4)
#else
#define SLEEP
#endif

void ndraw(mp_int *a, char *name) {
  char buf[4096];

  printf("%s: ", name);
  mp_toradix(a, buf, 64);
  printf("%s\n", buf);
}

static void draw(mp_int *a) { ndraw(a, ""); }

unsigned long lfsr = 0xAAAAAAAAUL;

int lbit(void) {
  if (lfsr & 0x80000000UL) {
    lfsr = ((lfsr << 1) ^ 0x8000001BUL) & 0xFFFFFFFFUL;
    return 1;
  } else {
    lfsr <<= 1;
    return 0;
  }
}

/* RDTSC from Scott Duplichan */
static ulong64 TIMFUNC(void) {
#if defined __GNUC__
#if defined(__i386__) || defined(__x86_64__)
  unsigned long long a;
  __asm__ __volatile__("rdtsc\nmovl %%eax,%0\nmovl %%edx,4+%0\n" ::"m"(a)
                       : "%eax", "%edx");
  return a;
#else /* gcc-IA64 version */
  unsigned long result;
  __asm__ __volatile__("mov %0=ar.itc" : "=r"(result)::"memory");

  while (__builtin_expect((int)result == -1, 0))
    __asm__ __volatile__("mov %0=ar.itc" : "=r"(result)::"memory");

  return result;
#endif

// Microsoft and Intel Windows compilers
#elif defined _M_IX86
  __asm rdtsc
#elif defined _M_AMD64
  return __rdtsc();
#elif defined _M_IA64
#if defined __INTEL_COMPILER
#include <ia64intrin.h>
#endif
  return __getReg(3116);
#else
#error need rdtsc function for this build
#endif
}

#define DO(x) \
  x;          \
  x;
//#define DO4(x) DO2(x); DO2(x);
//#define DO8(x) DO4(x); DO4(x);
//#define DO(x)  DO8(x); DO8(x);

int main(void) {
  ulong64 tt, gg, CLK_PER_SEC;
  FILE *log, *logb, *logc, *logd;
  mp_int a, b, c, d, e, f;
  int n, cnt, ix, old_kara_m, old_kara_s;
  unsigned rr;

  mp_init(&a);
  mp_init(&b);
  mp_init(&c);
  mp_init(&d);
  mp_init(&e);
  mp_init(&f);

  srand(time(NULL));

  /* temp. turn off TOOM */
  TOOM_MUL_CUTOFF = TOOM_SQR_CUTOFF = 100000;

  CLK_PER_SEC = TIMFUNC();
  sleep(1);
  CLK_PER_SEC = TIMFUNC() - CLK_PER_SEC;

  printf("CLK_PER_SEC == %llu\n", CLK_PER_SEC);
  goto exptmod;
  log = fopen("logs/add.log", "w");
  for (cnt = 8; cnt <= 128; cnt += 8) {
    SLEEP;
    mp_rand(&a, cnt);
    mp_rand(&b, cnt);
    rr = 0;
    tt = -1;
    do {
      gg = TIMFUNC();
      DO(mp_add(&a, &b, &c));
      gg = (TIMFUNC() - gg) >> 1;
      if (tt > gg) tt = gg;
    } while (++rr < 100000);
    printf("Adding\t\t%4d-bit => %9llu/sec, %9llu cycles\n", mp_count_bits(&a),
           CLK_PER_SEC / tt, tt);
    fprintf(log, "%d %9llu\n", cnt * DIGIT_BIT, tt);
    fflush(log);
  }
  fclose(log);

  log = fopen("logs/sub.log", "w");
  for (cnt = 8; cnt <= 128; cnt += 8) {
    SLEEP;
    mp_rand(&a, cnt);
    mp_rand(&b, cnt);
    rr = 0;
    tt = -1;
    do {
      gg = TIMFUNC();
      DO(mp_sub(&a, &b, &c));
      gg = (TIMFUNC() - gg) >> 1;
      if (tt > gg) tt = gg;
    } while (++rr < 100000);

    printf("Subtracting\t\t%4d-bit => %9llu/sec, %9llu cycles\n",
           mp_count_bits(&a), CLK_PER_SEC / tt, tt);
    fprintf(log, "%d %9llu\n", cnt * DIGIT_BIT, tt);
    fflush(log);
  }
  fclose(log);

/* do mult/square twice, first without karatsuba and second with */
multtest:
  old_kara_m = KARATSUBA_MUL_CUTOFF;
  old_kara_s = KARATSUBA_SQR_CUTOFF;
  for (ix = 0; ix < 2; ix++) {
    printf("With%s Karatsuba\n", (ix == 0) ? "out" : "");

    KARATSUBA_MUL_CUTOFF = (ix == 0) ? 9999 : old_kara_m;
    KARATSUBA_SQR_CUTOFF = (ix == 0) ? 9999 : old_kara_s;

    log = fopen((ix == 0) ? "logs/mult.log" : "logs/mult_kara.log", "w");
    for (cnt = 4; cnt <= 10240 / DIGIT_BIT; cnt += 2) {
      SLEEP;
      mp_rand(&a, cnt);
      mp_rand(&b, cnt);
      rr = 0;
      tt = -1;
      do {
        gg = TIMFUNC();
        DO(mp_mul(&a, &b, &c));
        gg = (TIMFUNC() - gg) >> 1;
        if (tt > gg) tt = gg;
      } while (++rr < 100);
      printf("Multiplying\t%4d-bit => %9llu/sec, %9llu cycles\n",
             mp_count_bits(&a), CLK_PER_SEC / tt, tt);
      fprintf(log, "%d %9llu\n", mp_count_bits(&a), tt);
      fflush(log);
    }
    fclose(log);

    log = fopen((ix == 0) ? "logs/sqr.log" : "logs/sqr_kara.log", "w");
    for (cnt = 4; cnt <= 10240 / DIGIT_BIT; cnt += 2) {
      SLEEP;
      mp_rand(&a, cnt);
      rr = 0;
      tt = -1;
      do {
        gg = TIMFUNC();
        DO(mp_sqr(&a, &b));
        gg = (TIMFUNC() - gg) >> 1;
        if (tt > gg) tt = gg;
      } while (++rr < 100);
      printf("Squaring\t%4d-bit => %9llu/sec, %9llu cycles\n",
             mp_count_bits(&a), CLK_PER_SEC / tt, tt);
      fprintf(log, "%d %9llu\n", mp_count_bits(&a), tt);
      fflush(log);
    }
    fclose(log);
  }
exptmod :

{
  char *primes[] = {
      /* 2K large moduli */
      "179769313486231590772930519078902473361797697894230657273430081157732675"
      "805500963132708477322407536021120113879871393357658789768814416622492847"
      "430639474124377767893424865485276302219601246094119453082952085005768838"
      "150682342462881473913110540827237163350510684586239334100047359817950870"
      "678242457666208137217",
      "323170060713110073007148766886699519604441026697154840321303454275246551"
      "388678908931972014115229134636887179609218980194941195591504909210950881"
      "523864482831206308773673009960917501977503896521067960576383840675682767"
      "922186426197561618380943384761704705816458520363050428875758915410658086"
      "075523991239303855219143333896683424206849747865645694948561760353263220"
      "580778056593310261927084603141502585928641771167259436037184618573575983"
      "511523016459044036976132332872312271256847108202097251571017269313234696"
      "785425806566979350459972683529986380997330771521211401200311504245416967"
      "91951097529546801429027668869927491725169",
      "104438888141315250669175271071662438257996424904738378038423348328395390"
      "797155745684882681193499755834089010671443926283798757343818579360726323"
      "608785136527794595697654370999834036159013438371831442807001185594622637"
      "631883939771274567233468434458661749680790870580370407128404874011860911"
      "446797778359802900668693897688178778594690563019026094059957945343282346"
      "930302669644305902501597239986771421554169383555988529148631823791443449"
      "673408781187263949647510018904134900841706167509366833385055103297208826"
      "955076998361636941193301521379682583718809183365675122131849284636812555"
      "022599830041234478486259567449219461702380650591324561082573183538008760"
      "862210283427019769820231316901767800667519548507992163641937028537512478"
      "401490715913545998279051339961155179427110683113409058427288427979155484"
      "978295432353451706522326906139490598769300212296339568778287894844061600"
      "741294567491982305057164237715481632138063104590291613692670834285644073"
      "044789997190178146576347322385026725305989979599609079946920177462481771"
      "844986745565925017832907047311943316555080756822184657174637329688491281"
      "952031745700244092661691087414838507841192980452298185733897764810312608"
      "590299520825742185524979672172903974411816593843369482332569664209689212"
      "4547425283",
      /* 2K moduli mersenne primes */
      "686479766013060971498190079908139321726943530014330540939446345918554318"
      "339765605212255964066145455497729631139148085803712198799971664381257402"
      "8291115057151",
      "531137992816767098689588206552468627329593117727031923199444138200403559"
      "860852242739162502265229285668889329486246501015346579337652707239409519"
      "978766587351943831270835393219031728127",
      "104079321946643990819252403273640855386152622472667048053191123504036080"
      "596733602980122394417323241848424216139542810077913835662483234649081399"
      "066056773207629241295093892203457731833496615835504729594205476898112116"
      "936771475484788669625013844382602917323488853111608285384165850282556046"
      "662248318909188018470682222031405210266984354887329580288780508697361869"
      "00714720710555703168729087",
      "147597991521418023508489862273738173631206614533316977514777121647857029"
      "787807894937740733704938928938274850753149648047728126483876025919181446"
      "336533026954049696120111343015690239609398909022625932693502528140961498"
      "349938822283144859860183431853623092377264139020949023183644689960821079"
      "548296376309423663094541083279376990539998245718632294472963641889062337"
      "217172374210563644036821845964963294853869690587265048691443463745750728"
      "044182367681351785209934866084717257940842231667809767022401199028017047"
      "489448742692474210882353680848507250224051945258754287534997655857267022"
      "963396257521263747789778550155264652260998886991401354048380986568125041"
      "9497686697771007",
      "259117086013202627776246767922441530941818887553125427303974923161874019"
      "266586362086201209516800483406550695241733194177441689509238807017410377"
      "709597512042313066624082916353517952311186154862265604547691127595848775"
      "610568757931191017711408826252153849035830401185072116424747461823031471"
      "398340229288074545677907941037288235820705892351068433882986888616658650"
      "280927692080339605869308790500409503709875902119018371991620994002568935"
      "113136548829739112656797303241986517250116412703509705427773477972349821"
      "676443446668383119322540099648994051790241624056519054483690809616061625"
      "743042361721863339415852426431208737266591962061753535748892894599629195"
      "183082621860853400937932839420261866586142503251450773096274235376822938"
      "649407127700846077124211823080804139298087057504713825264571448379371125"
      "032081826126566649084251699453951887789613650248405739378594599444335231"
      "188280123660406262468609212150349937584782292237144339628858485938215738"
      "821232393687046160677362909315071",
      "190797007524439073807468042969529173669356994749940177394741882673528979"
      "787005053706368049835514900244303495954950709725762186311224148828811920"
      "216904542206960744666169364221195289538436845390250168663932838805192055"
      "137154390912666527533007309292687539092257043362517857366624699975402375"
      "462954490293259233303137330643531556539739921926201438606439020075174723"
      "029056838272505051571967594608350063404495977660656269020823960825567012"
      "344189908927956646011998057988548630107637380993519826582389781888135705"
      "408653045219655801758081251164080554609057468028203308718724654081055323"
      "215860189611391296030471108443146745671967766308925858547271507311563765"
      "171008318248647110097614890313562856541784154881743146033909602737947385"
      "055355960331855614540900081456378659068370317267696980001187750995491090"
      "350108417050917991562167972281070161305972518044872048331306383715094854"
      "938415738549894606070722584737978176686422134354526989443028353644037187"
      "375385397838259511833166416134323695660367676897722287918773420968982326"
      "089026150031515424165462111337527431154890666327374921446276833564519776"
      "797633875503548665093914556482031482248883127023777039667707976559857333"
      "357013727342079099064400455741830654320379350833236245819348824064783585"
      "692924881021978332974949906122664421376034687815350484991",

      /* DR moduli */
      "140591056079474886962829328365186933089678034946934894784398611644119924"
      "395983995947470021440746589285935028457297527972600258314234196865281516"
      "09940203368612079",
      "101745825697019260773923519755878567461315282017759829107608914364075275"
      "235254395622580447400994175578963163918967182013639660669771108475957692"
      "810857098847138903161308502419410142185759152435680068435915159402496058"
      "513611411688900243039",
      "736335108039604595805923406147184530889923370574768772191969612422073040"
      "099331944991573923112581267542507986451953227192970402893063850485730703"
      "075899286013451337291468249027691733891486704001513279827771740183629161"
      "065194874727962517148100775228363421083691764065477590823919364012917984"
      "605619526140821797602431",
      "385649988307365214172818656964530258065934919671310232217548006250441182"
      "654688512107053603857175367946151802604942080766057986716607193331995138"
      "078062523944232834134301060035963325132466829039948295286901982051209215"
      "575337264735857513821939535921274399650502614768108420715736845058788545"
      "887066234845739259259035057475454710888677121850041352012892734056144158"
      "994382765356263460989042410208779740029161680999518854063792955362004134"
      "93190419727789712076165162175783",
      "542189391331696172661670440619180536749994166415993334151601745392193484"
      "590296600979602378676624808129613777993466242203025054573692562689251250"
      "471628358318743978285860720148446448885701001277560572526947619392551574"
      "490839286458454994488665744991822837769918095117129546414124448777033941"
      "223565831420390846864429504774477949153794689948747680362212954278693335"
      "653935890352619041936727463717926744868338358149568368643403037768649616"
      "778526013610493696186055899318268339432671541328195724261329606699831016"
      "666359440874843103020666106568222401047720269951530296879490444224546654"
      "729111504346660859907296364097126834834235287147",
      "148725913481470926409203264852597103889586564514890118058534045498552415"
      "513526021778875802740047831225633949638527501246566157557620225206314569"
      "873207988029466422057976484876770407676185319721656326266004660270397305"
      "079821824617083596200559856166970684446944743546109254226579244494770676"
      "961569525225613090127187034100576891297443368452143621126335809752272646"
      "208391793909176002665892575707673348417320292714144149257379991424022262"
      "879540562395310913159452362335304489833948149412011272344568964798647527"
      "924244608315141366758700819168256437641234796414611389856588668313940700"
      "594138366932599747507691048808666325633568918115795757144506749018793955"
      "316590377355429026053100912187904417076661523230093667536945126074767143"
      "207339486753082052747917246410644245072764022650374658634027981631882139"
      "521072626829153564850619071461608316340318994333443105687603828653036575"
      "7187367147446004855912033137386225053275419626102417236133948503",
      "109512111571667780285681129039239512858816859240910949490017800896795525"
      "300518383187271542315155199973485718453819986446960565780551910671752965"
      "504405483319768745978263629725521974299473675154181526972794075186067026"
      "877490334029604000611401397130925702833284967909682480025074269171861067"
      "081237427241408686371576372462279750943706251808238305605014462496277630"
      "214789052124947706021514827516368830127584715531604227940555763263936606"
      "684744286142216483265587465582422157784992886302301836683567539994974042"
      "933246818634051817248707336082222044905534058256846156864525995487330361"
      "695377639385317484513208112197632746274035493074448742961720258501551074"
      "429853010154770682159018873351588073352744978096316390983007761635750684"
      "552321528929762408691454537851108253422962011656326016849452390656670941"
      "816601111275452976618355457932122494095117739408846559671262007624006737"
      "058903692402472837507621047726748867900801657958869619119406012731903519"
      "537013716093688240224439969917201783514453748848639690614421772002899286"
      "394128821718535391499158340042168275100060359665579099081552512615439434"
      "464133639779379149706825393677101703198086770670749022404107582633738353"
      "865182549367950377193483609465580277633166426163174014828176348776585274"
      "6577808019633679",

      /* generic unrestricted moduli */
      "179336011948601133722370705621651283500273200721768442266732879458733707"
      "512454395877923719606150738556692740878050555079773230248868809850620028"
      "53331424203",
      "289352772070966123949389656233954408862037573649040846801188303046993990"
      "436808609233645829822124570789893358319071318817739940185262774921099459"
      "597479178279025394653904396221302707492255957231214118178743427870878320"
      "7966459019479487",
      "347743159439876626079252796797422223177535447388206607607181663903045907"
      "591201940478223621722118173270898487582987137708656414344685816179420855"
      "160986340457973820182883508387588163122354089264395604796675278966117567"
      "294812714812796820596564876450716066283126720010859041484786529056457896"
      "367683122960411136319",
      "472664289563563931646973650981204189764006027060723127359240717454385322"
      "182379793333517749073081683406933266873174437211932662151557358145107921"
      "487685764984911991227443513994894535335532038333186916782632419417062569"
      "961974604240290124190126346718622835323426563096771736025094984179760915"
      "091543600398931650376370347370203273999104098857981857710035053205839677"
      "372934159799173173389858373857347474783642420203804168920566508414708692"
      "945275435973492502995396824306051733210290265555468324730486003270368457"
      "819702892888983178884275173649453167090811738401861507943974790450340082"
      "57793436817683392375274635794835245695887",
      "436463808505957768574894870394349739623346440601945961161254440072143298"
      "152040105676491048248110146278752857839930515766167441407021501229924721"
      "335644557342265864606569000117714935185566842453630868849121480179691838"
      "399545644365571106757731317371758557990781880691336695584799313313687287"
      "468894148823761785582982549586183756806449017542622267874275103877481475"
      "534991201849912222670102069951687572917937634467778042874315463238062009"
      "202992087620963771759666448266532858079402669920025224220613419441069718"
      "482837399612644978839925207109870840278194042158748845445131729137117098"
      "529028886770063736487420613144045836803985635654192482395882603511950547"
      "826439092832800532152534003936926017612446606135655146445620623395788978"
      "726744728503058670046885876251527122350275750995227",
      "114241674733518363980783060426243622779564294405211370618897026117663487"
      "606922062431404134110773945831807268632770120166022792901441267851295694"
      "749091735847898223419867427192303319460727303195559844849117167970588759"
      "054009995043058772458491196875090232327902736374668210525768592324529820"
      "618310097707860317856690302715422866039561187555856839961188962152134888"
      "752531018946634030696777459483058938495054342017637452328957807119724320"
      "113448575216910178963168614032064494213322436588554534357840065172028941"
      "816405624335753908213842109601175186503746022566010913796440342443322850"
      "659354132335579983315627491402029658442193362989700115138825649355387042"
      "894469683222814519074873620465114612213297998973509933705606975058096864"
      "387820362353721370157313047790724302609864602698945221591030082604955030"
      "052671659275429494395262727365866267095817210321895327263896436255906801"
      "05784844246152702670169304203783072275089194754889511973916207",
      "121485563681656263750258406016340383027070500063471348301510138488187197"
      "844680122479853615540689582330503546759163253106754789094869511717207695"
      "422072707568804875102242119871203284889005635784597424656074834791863005"
      "085393369779225495589043972029756069357940029706239690430627014588683071"
      "930929635276529571218304077314641902287516538277800704010995760973958987"
      "559088570112619790606362013395489321661267883850754077713843779770560245"
      "371955901763398648664952361197586500571237119406761226333033559052617608"
      "700442136359847030273134913877320590144770468218151790406473563651846245"
      "224279167654172529237892556829685801015185232631677751193503753101741391"
      "050692192245066693320227848902452126379848223715005683574645484266204869"
      "212717383443308901610785449109745672501632770966319973823844216484314713"
      "278915372551325716791555516209497085358444799312548860769600816980737473"
      "671129700747381225627224548940589847029717873802948445969083625056049546"
      "157953325447331634060821787678198618870592827073569575283082552796383835"
      "541976251624602868028098802040191455182548734999030697630409310938445143"
      "881325121105159739212749146489879740678917545306796007200859061488653233"
      "301588117136710444504471814431241681571221661157622154645596877080141344"
      "0778423979",
      NULL};
  log = fopen("logs/expt.log", "w");
  logb = fopen("logs/expt_dr.log", "w");
  logc = fopen("logs/expt_2k.log", "w");
  logd = fopen("logs/expt_2kl.log", "w");
  for (n = 0; primes[n]; n++) {
    SLEEP;
    mp_read_radix(&a, primes[n], 10);
    mp_zero(&b);
    for (rr = 0; rr < (unsigned)mp_count_bits(&a); rr++) {
      mp_mul_2(&b, &b);
      b.dp[0] |= lbit();
      b.used += 1;
    }
    mp_sub_d(&a, 1, &c);
    mp_mod(&b, &c, &b);
    mp_set(&c, 3);
    rr = 0;
    tt = -1;
    do {
      gg = TIMFUNC();
      DO(mp_exptmod(&c, &b, &a, &d));
      gg = (TIMFUNC() - gg) >> 1;
      if (tt > gg) tt = gg;
    } while (++rr < 10);
    mp_sub_d(&a, 1, &e);
    mp_sub(&e, &b, &b);
    mp_exptmod(&c, &b, &a, &e); /* c^(p-1-b) mod a */
    mp_mulmod(&e, &d, &a, &d);  /* c^b * c^(p-1-b) == c^p-1 == 1 */
    if (mp_cmp_d(&d, 1)) {
      printf("Different (%d)!!!\n", mp_count_bits(&a));
      draw(&d);
      exit(0);
    }
    printf("Exponentiating\t%4d-bit => %9llu/sec, %9llu cycles\n",
           mp_count_bits(&a), CLK_PER_SEC / tt, tt);
    fprintf(n < 4 ? logd : (n < 9) ? logc : (n < 16) ? logb : log, "%d %9llu\n",
            mp_count_bits(&a), tt);
  }
}
  fclose(log);
  fclose(logb);
  fclose(logc);
  fclose(logd);

  log = fopen("logs/invmod.log", "w");
  for (cnt = 4; cnt <= 128; cnt += 4) {
    SLEEP;
    mp_rand(&a, cnt);
    mp_rand(&b, cnt);

    do {
      mp_add_d(&b, 1, &b);
      mp_gcd(&a, &b, &c);
    } while (mp_cmp_d(&c, 1) != MP_EQ);

    rr = 0;
    tt = -1;
    do {
      gg = TIMFUNC();
      DO(mp_invmod(&b, &a, &c));
      gg = (TIMFUNC() - gg) >> 1;
      if (tt > gg) tt = gg;
    } while (++rr < 1000);
    mp_mulmod(&b, &c, &a, &d);
    if (mp_cmp_d(&d, 1) != MP_EQ) {
      printf("Failed to invert\n");
      return 0;
    }
    printf("Inverting mod\t%4d-bit => %9llu/sec, %9llu cycles\n",
           mp_count_bits(&a), CLK_PER_SEC / tt, tt);
    fprintf(log, "%d %9llu\n", cnt * DIGIT_BIT, tt);
  }
  fclose(log);

  return 0;
}

/* $Source: /cvs/libtom/libtommath/demo/timing.c,v $ */
/* $Revision: 1.2 $ */
/* $Date: 2005/05/05 14:38:47 $ */
